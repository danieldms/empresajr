define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(e,t,i,o,a,n,r){var l=(n.set,a.unitize),s=a.calculateDistance,d=require.on,_=100,c=100;return t("Ti._.UI.KineticScrollView",i,{_initKineticScrollView:function(e,t,i,o){function a(){g=Date.now(),v=g-p,p=g,m++?(b=(b*(m-1)+m*(u-I)/v)/2/m,T=(T*(m-1)+m*(h-w)/v)/2/m):(b=(u-_)/v,T=(h-c)/v)}function n(){f=C._minTranslationX=Math.min(0,C._measuredWidth-C._borderLeftWidth-C._borderRightWidth-C._contentContainer._measuredWidth),y=C._minTranslationY=Math.min(0,C._measuredHeight-C._borderTopWidth-C._borderBottomWidth-C._contentContainer._measuredHeight)}var l,_,c,u,h,f,y,p,g,v,I,w,m,b,T,E,C=this;C._currentTranslationX=0,C._currentTranslationY=0,C._horizontalElastic="horizontal"===t||"both"===t,C._verticalElastic="vertical"===t||"both"===t,C._kineticTransform=r.create2DMatrix(),("horizontal"===i||"both"===i)&&C._createHorizontalScrollBar(),("vertical"===i||"both"===i)&&C._createVerticalScrollBar(),C._add(C._contentContainer=e),l=e.domNode,d(C._contentContainer,"postlayout",function(){n(),C._setTranslation(C._currentTranslationX,C._currentTranslationY)}),d(C,"draggingstart",function(t){if(C.scrollingEnabled){C._cancelAnimations(),b=void 0,T=void 0,_=C._currentTranslationX,c=C._currentTranslationY,m=0,p=(new Date).getTime(),n();var i=C._measuredWidth,o=C._measuredHeight,a=e._measuredWidth,r=e._measuredHeight;C._startScrollBars({x:-C._currentTranslationX/(a-i),y:-C._currentTranslationY/(r-o)},{x:i/a,y:o/r}),C._handleDragStart&&C._handleDragStart(t)}}),d(C,"dragging",function(e){C.scrollingEnabled&&(u=_+e.distanceX,h=c+e.distanceY,a(),C._setTranslation(I=u,w=h),C._handleDrag&&C._handleDrag(e))}),d(C,"draggingcancel",function(e){C.scrollingEnabled&&(C._animateToPosition(_,c,400+.3*s(_,c,C._currentTranslationX,C._currentTranslationY),r.ANIMATION_CURVE_EASE_IN_OUT,function(){C._handleDragCancel&&C._handleDragCancel(e)}),C._endScrollBars(),C._handleDragCancel&&C._handleDragCancel(e))}),d(C,"draggingend",function(e){if(C.scrollingEnabled){u=_+e.distanceX,h=c+e.distanceY,a();var t,i=C._currentTranslationX,o=C._currentTranslationY;i>0?(i=0,t=1):f>i&&(i=f,t=1),o>0?(o=0,t=1):y>o&&(o=y,t=1),t?C._animateToPosition(i,o,200,r.ANIMATION_CURVE_EASE_OUT,function(){C._handleDragEnd&&C._handleDragEnd(e),C._endScrollBars()}):C._handleDragEnd&&C._handleDragEnd(e,b,T)}}),o&&(this._disconnectMouseWheelEvent=d(C.domNode,"mousewheel",function(t){if(C.scrollingEnabled){C._cancelAnimations();var i=e._measuredWidth-C._measuredWidth,o=e._measuredHeight-C._measuredHeight,a=-C._currentTranslationX,r=-C._currentTranslationY;n(),C._startScrollBars({x:a/i,y:r/o},{x:C._measuredWidth/e._measuredWidth,y:C._measuredHeight/e._measuredHeight}),C._setTranslation(Math.min(0,Math.max(C._minTranslationX,-a+t.wheelDeltaX)),Math.min(0,Math.max(C._minTranslationY,-r+t.wheelDeltaY))),clearTimeout(E),E=setTimeout(function(){C._endScrollBars()},500),C._handleMouseWheel&&C._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),i.prototype.destroy.apply(this,arguments)},_animateToPosition:function(e,t,i,o,a){var n,r=this,l=r._contentContainer,d=(l.domNode,r._horizontalScrollBar),_=r._verticalScrollBar;1>s(r._currentTranslationX,r._currentTranslationY,e,t)?(r._setTranslation(e,t),a()):(n=r._setTranslation(e,t,1),r._contentAnimation=l.animate({transform:r._kineticTransform.translate(n.translationX,n.translationY),duration:Math.round(i),curve:o},a),r._horizontalScrollBarAnimation=d&&d.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-n.translationX/(l._measuredWidth-r._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:i,curve:o}),r._verticalScrollBarAnimation=_&&_.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-n.translationY/(l._measuredHeight-r._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:i,curve:o}))},_setTranslation:function(e,t,i){function o(e){return _*(-1/(e/c+1)+1)}var a=this._contentContainer,n=this._minTranslationX,r=this._minTranslationY,l=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<a._measuredWidth,s=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<a._measuredHeight,d=this._measuredWidth,u=this._measuredHeight,h=a._measuredWidth,f=a._measuredHeight;if(e>0?e=l?o(e):0:n>e&&(e=l?n-o(n-e):n),t>0?t=s?o(t):0:r>t&&(t=s?r-o(r-t):r),i||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=e,this._currentTranslationY=t)}),this._isScrollBarActive){var y=this._horizontalScrollBar,p=this._verticalScrollBar;y&&y.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-e/(h-d)))*(this._measuredWidth-this._scrollBarWidth),0)}),p&&p.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-t/(f-u)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:e,translationY:t}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=r.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=r.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(e,t){if(this._horizontalScrollBar&&1>t.x&&t.x>0){var i=this._measuredWidth,o=this._scrollBarWidth=Math.round(Math.max(10,i*t.x)),a=this._horizontalScrollBar;a.opacity=.5,a.domNode.style.width=l(o),a.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,e.x))*(i-o),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&1>t.y&&t.y>0){var n=this._measuredHeight,r=this._scrollBarHeight=Math.round(Math.max(10,n*t.y)),s=this._verticalScrollBar;s.opacity=.5,s.domNode.style.height=l(r),s.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,e.y))*(n-r))}),this._isScrollBarActive=1}},_endScrollBars:function(){function e(e){e&&e.animate({opacity:0,duration:500},function(){t._isScrollBarActive=!1})}if(this._isScrollBarActive){var t=this,i=t._horizontalScrollBar,o=t._verticalScrollBar;e(i),e(o)}},properties:{scrollingEnabled:!0}})});