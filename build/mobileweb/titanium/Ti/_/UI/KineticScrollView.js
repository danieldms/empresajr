define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(e,t,i,o,n,a,r){var s=(a.set,n.unitize),l=n.calculateDistance,d=require.on,_=100,c=100;return t("Ti._.UI.KineticScrollView",i,{_initKineticScrollView:function(e,t,i,o){function n(){y=Date.now(),v=y-p,p=y,I++?(b=(b*(I-1)+I*(u-m)/v)/2/I,T=(T*(I-1)+I*(h-w)/v)/2/I):(b=(u-_)/v,T=(h-c)/v)}function a(){f=E._minTranslationX=Math.min(0,E._measuredWidth-E._borderLeftWidth-E._borderRightWidth-E._contentContainer._measuredWidth),g=E._minTranslationY=Math.min(0,E._measuredHeight-E._borderTopWidth-E._borderBottomWidth-E._contentContainer._measuredHeight)}var s,_,c,u,h,f,g,p,y,v,m,w,I,b,T,x,E=this;E._currentTranslationX=0,E._currentTranslationY=0,E._horizontalElastic="horizontal"===t||"both"===t,E._verticalElastic="vertical"===t||"both"===t,E._kineticTransform=r.create2DMatrix(),("horizontal"===i||"both"===i)&&E._createHorizontalScrollBar(),("vertical"===i||"both"===i)&&E._createVerticalScrollBar(),E._add(E._contentContainer=e),s=e.domNode,d(E._contentContainer,"postlayout",function(){a(),E._setTranslation(E._currentTranslationX,E._currentTranslationY)}),d(E,"draggingstart",function(t){if(E.scrollingEnabled){E._cancelAnimations(),b=void 0,T=void 0,_=E._currentTranslationX,c=E._currentTranslationY,I=0,p=(new Date).getTime(),a();var i=E._measuredWidth,o=E._measuredHeight,n=e._measuredWidth,r=e._measuredHeight;E._startScrollBars({x:-E._currentTranslationX/(n-i),y:-E._currentTranslationY/(r-o)},{x:i/n,y:o/r}),E._handleDragStart&&E._handleDragStart(t)}}),d(E,"dragging",function(e){E.scrollingEnabled&&(u=_+e.distanceX,h=c+e.distanceY,n(),E._setTranslation(m=u,w=h),E._handleDrag&&E._handleDrag(e))}),d(E,"draggingcancel",function(e){E.scrollingEnabled&&(E._animateToPosition(_,c,400+.3*l(_,c,E._currentTranslationX,E._currentTranslationY),r.ANIMATION_CURVE_EASE_IN_OUT,function(){E._handleDragCancel&&E._handleDragCancel(e)}),E._endScrollBars(),E._handleDragCancel&&E._handleDragCancel(e))}),d(E,"draggingend",function(e){if(E.scrollingEnabled){u=_+e.distanceX,h=c+e.distanceY,n();var t,i=E._currentTranslationX,o=E._currentTranslationY;i>0?(i=0,t=1):f>i&&(i=f,t=1),o>0?(o=0,t=1):g>o&&(o=g,t=1),t?E._animateToPosition(i,o,200,r.ANIMATION_CURVE_EASE_OUT,function(){E._handleDragEnd&&E._handleDragEnd(e),E._endScrollBars()}):E._handleDragEnd&&E._handleDragEnd(e,b,T)}}),o&&(this._disconnectMouseWheelEvent=d(E.domNode,"mousewheel",function(t){if(E.scrollingEnabled){E._cancelAnimations();var i=e._measuredWidth-E._measuredWidth,o=e._measuredHeight-E._measuredHeight,n=-E._currentTranslationX,r=-E._currentTranslationY;a(),E._startScrollBars({x:n/i,y:r/o},{x:E._measuredWidth/e._measuredWidth,y:E._measuredHeight/e._measuredHeight}),E._setTranslation(Math.min(0,Math.max(E._minTranslationX,-n+t.wheelDeltaX)),Math.min(0,Math.max(E._minTranslationY,-r+t.wheelDeltaY))),clearTimeout(x),x=setTimeout(function(){E._endScrollBars()},500),E._handleMouseWheel&&E._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),i.prototype.destroy.apply(this,arguments)},_animateToPosition:function(e,t,i,o,n){var a,r=this,s=r._contentContainer,d=(s.domNode,r._horizontalScrollBar),_=r._verticalScrollBar;1>l(r._currentTranslationX,r._currentTranslationY,e,t)?(r._setTranslation(e,t),n()):(a=r._setTranslation(e,t,1),r._contentAnimation=s.animate({transform:r._kineticTransform.translate(a.translationX,a.translationY),duration:Math.round(i),curve:o},n),r._horizontalScrollBarAnimation=d&&d.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-a.translationX/(s._measuredWidth-r._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:i,curve:o}),r._verticalScrollBarAnimation=_&&_.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-a.translationY/(s._measuredHeight-r._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:i,curve:o}))},_setTranslation:function(e,t,i){function o(e){return _*(-1/(e/c+1)+1)}var n=this._contentContainer,a=this._minTranslationX,r=this._minTranslationY,s=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<n._measuredWidth,l=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<n._measuredHeight,d=this._measuredWidth,u=this._measuredHeight,h=n._measuredWidth,f=n._measuredHeight;if(e>0?e=s?o(e):0:a>e&&(e=s?a-o(a-e):a),t>0?t=l?o(t):0:r>t&&(t=l?r-o(r-t):r),i||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=e,this._currentTranslationY=t)}),this._isScrollBarActive){var g=this._horizontalScrollBar,p=this._verticalScrollBar;g&&g.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-e/(h-d)))*(this._measuredWidth-this._scrollBarWidth),0)}),p&&p.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-t/(f-u)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:e,translationY:t}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=r.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=r.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(e,t){if(this._horizontalScrollBar&&1>t.x&&t.x>0){var i=this._measuredWidth,o=this._scrollBarWidth=Math.round(Math.max(10,i*t.x)),n=this._horizontalScrollBar;n.opacity=.5,n.domNode.style.width=s(o),n.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,e.x))*(i-o),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&1>t.y&&t.y>0){var a=this._measuredHeight,r=this._scrollBarHeight=Math.round(Math.max(10,a*t.y)),l=this._verticalScrollBar;l.opacity=.5,l.domNode.style.height=s(r),l.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,e.y))*(a-r))}),this._isScrollBarActive=1}},_endScrollBars:function(){function e(e){e&&e.animate({opacity:0,duration:500},function(){t._isScrollBarActive=!1})}if(this._isScrollBarActive){var t=this,i=t._horizontalScrollBar,o=t._verticalScrollBar;e(i),e(o)}},properties:{scrollingEnabled:!0}})});