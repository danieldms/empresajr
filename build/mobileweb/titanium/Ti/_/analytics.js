define(["Ti/_","Ti/_/dom","Ti/_/has","Ti/_/lang","Ti/App","Ti/Platform"],function(_,dom,has,lang,App,Platform){function getStorage(){var e=localStorage.getItem("ti:analyticsEvents");return e?JSON.parse(e):[]}function setStorage(e){localStorage.setItem("ti:analyticsEvents",JSON.stringify(e))}function onSuccess(e){if(is(e.data,"Object")&&e.data.success){var t,i=pending[e.data.callback],o=[],n=getStorage(),r=0,a=n.length;if(i){for(;a>r;)t=n[r++],~i.indexOf(t.id)||o.push(t);setStorage(o)}}}var global=window,is=require.is,cfg=require.config,analyticsEnabled=App.analytics,analyticsLastSent=null,analyticsUrl="https://api.appcelerator.net/p/v3/mobile-web-track/"+App.guid,pending={},sendTimer,sendDelay=6e4,analytics={add:function(e,t,i,o){if(analyticsEnabled){var n=getStorage();n.push({id:_.uuid(),type:e,evt:t,ts:(new Date).toISOString().replace("Z","+0000"),data:i}),setStorage(n),this.send(o)}},send:function(isUrgent){if(analyticsEnabled){var rand=Math.floor(1e6*Math.random()),now=Date.now(),ids=[],jsonStrs=[],sessionId=sessionStorage.getItem("ti:sessionId"),seqId=sessionStorage.getItem("ti:analyticsSeqId"),events=getStorage(),i=0,len=events.length,evt;if(is(seqId,"String")&&(seqId=JSON.parse(seqId)),clearTimeout(sendTimer),len&&(isUrgent||null===analyticsLastSent||now-analyticsLastSent>=sendDelay)){for(sessionId||(sessionId=_.uuid()),null===seqId&&(seqId=0);len>i;)evt=events[i++],ids.push(evt.id),jsonStrs.push(JSON.stringify({id:evt.id,mid:Platform.id,rdu:null,type:evt.type,aguid:App.guid,event:evt.evt,seq:seqId++,ver:"2",deploytype:App.deployType,sid:sessionId,ts:evt.ts,data:evt.data})),"ti.end"===evt.type&&(seqId=0,sessionId=_.uuid());if(sessionStorage.setItem("ti:sessionId",sessionId),sessionStorage.setItem("ti:analyticsSeqId",seqId),pending[rand]=ids,analyticsLastSent=now,has("analytics-use-xhr")){var xhr=new XmlHttpRequest;xhr.onreadystatechange=function(){if(4===xhr.readyState&&200===xhr.status)try{onSuccess({data:eval("("+xhr.responseText+")")})}catch(e){}},xhr.open("POST",analyticsUrl,!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(lang.urlEncode({content:jsonStrs}))}else{var body=document.body,iframeName="analytics"+rand,iframe=dom.create("iframe",{id:iframeName,name:iframeName,style:{display:"none"}},body),form=dom.create("form",{action:analyticsUrl+"?callback="+rand+"&output=html",method:"POST",style:{display:"none"},target:iframeName},body);dom.create("input",{name:"content",type:"hidden",value:"["+jsonStrs.join(",")+"]"},form),setTimeout(function(){function e(){setTimeout(function(){dom.destroy(form),dom.destroy(iframe)},1)}iframe.onload=e,iframe.onerror=e,form.submit()},25)}}sendTimer=setTimeout(function(){analytics.send(1)},sendDelay)}}};return require.on(global,"message",onSuccess),analytics});