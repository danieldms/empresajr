define(["Ti/_/Layouts/Base","Ti/_/declare","Ti/UI","Ti/_/lang"],function(e,t,i,o){var n=o.isDef,a="px",r=Math.round;return t("Ti._.Layouts.Composite",e,{_doLayout:function(e,t,o,n,l){var s,d,_,c,u,h,f,y,p,g,v,w,m,I,b,T,E,C,S={width:0,height:0},k=e._children,A=0,x=[],L=[],N=k.length,U=this._measureNode;for(A=0;N>A;A++)s=e._children[A],s._alive&&s.domNode?(s._markedForLayout&&((s._preLayout&&s._preLayout(t,o,n,l)||s._needsMeasuring)&&U(s,s,s._layoutCoefficients,this),d=s._layoutCoefficients,_=d.width,p=d.minWidth,c=d.height,g=d.minHeight,u=d.sandboxWidth,h=d.sandboxHeight,y=d.left,f=d.top,w=_.x1*t+_.x2,void 0!==p.x1&&(w=Math.max(w,p.x1*t+p.x2)),m=c.x1*o+c.x2,void 0!==g.x1&&(m=Math.max(m,g.x1*o+g.x2)),v=s._getContentSize?s._getContentSize(w,m):s._layout._doLayout(s,isNaN(w)?t:w-s._borderLeftWidth-s._borderRightWidth,isNaN(m)?o:m-s._borderTopWidth-s._borderBottomWidth,isNaN(w),isNaN(m)),isNaN(w)&&(w=v.width+s._borderLeftWidth+s._borderRightWidth,void 0!==p.x1&&(w=Math.max(w,p.x1*t+p.x2))),isNaN(m)&&(m=v.height+s._borderTopWidth+s._borderBottomWidth,void 0!==g.x1&&(m=Math.max(m,g.x1*o+g.x2))),n&&0!==y.x1?x.push(s):T=y.x1*t+y.x2*w+y.x3,l&&0!==f.x1?L.push(s):E=f.x1*o+f.x2*m+f.x3,s._measuredSandboxWidth=b=u.x1*o+u.x2+w+(isNaN(T)?0:T),s._measuredSandboxHeight=I=h.x1*o+h.x2+m+(isNaN(E)?0:E),s._measuredWidth=w,s._measuredHeight=m,s._measuredLeft=T,s._measuredTop=E),s._measuredSandboxWidth>S.width&&(S.width=s._measuredSandboxWidth),s._measuredSandboxHeight>S.height&&(S.height=s._measuredSandboxHeight)):this.handleInvalidState(s,e);for(N=x.length,A=0;N>A;A++)s=x[A],y=s._layoutCoefficients.left,u=s._layoutCoefficients.sandboxWidth,s._measuredLeft=T=y.x1*S.width+y.x2*w+y.x3,s._measuredSandboxWidth=b=u.x1*o+u.x2+s._measuredWidth+T,b=s._measuredSandboxWidth,b>S.width&&(S.width=b);for(N=L.length,A=0;N>A;A++)s=L[A],f=s._layoutCoefficients.top,h=s._layoutCoefficients.sandboxHeight,s._measuredTop=E=f.x1*S.height+f.x2*m+f.x3,s._measuredSandboxHeight=I=h.x1*o+h.x2+s._measuredHeight+E,I=s._measuredSandboxHeight,I>S.height&&(S.height=I);for(N=k.length,A=0;N>A;A++)s=k[A],s._markedForLayout&&(i._elementLayoutCount++,C=s.domNode.style,C.zIndex=s.zIndex,C.left=r(s._measuredLeft)+a,C.top=r(s._measuredTop)+a,C.width=r(s._measuredWidth-s._borderLeftWidth-s._borderRightWidth)+a,C.height=r(s._measuredHeight-s._borderTopWidth-s._borderBottomWidth)+a,s._markedForLayout=!1,s.fireEvent("postlayout"));return this._computedSize=S},_getWidth:function(e,t){return!n(t)&&2>n(e.left)+n(e.center&&e.center.x)+n(e.right)&&(t=e._defaultWidth),t===i.INHERIT?e._parent._parent?e._parent._parent._layout._getWidth(e._parent,e._parent.width)===i.SIZE?i.SIZE:i.FILL:i.FILL:t},_getHeight:function(e,t){return!n(t)&&2>n(e.top)+n(e.center&&e.center.y)+n(e.bottom)&&(t=e._defaultHeight),t===i.INHERIT?e._parent._parent?e._parent._parent._layout._getHeight(e._parent,e._parent.height)===i.SIZE?i.SIZE:i.FILL:i.FILL:t},_isDependentOnParent:function(e){var t=e._layoutCoefficients;return!isNaN(t.width.x1)&&0!==t.width.x1||!isNaN(t.height.x1)&&0!==t.height.x1||0!==t.left.x1||0!==t.top.x1},_doAnimationLayout:function(e,t){var i=e._parent._measuredWidth,o=e._parent._measuredHeight,n=t.width.x1*i+t.width.x2,a=t.height.x1*o+t.height.x2;return{width:n,height:a,left:t.left.x1*i+t.left.x2*n+t.left.x3,top:t.top.x1*o+t.top.x2*a+t.top.x3}},_measureNode:function(e,t,o,n){e._needsMeasuring=!1;for(var a,r,l,s,d,_,c,u,h,f,y,p,g,v=n.getValueType,w=n.computeValue,m=n._getWidth(e,t.width),I=v(m),b=w(m,I),T=t._minWidth,E=v(T),C=w(T,E),S=n._getHeight(e,t.height),k=v(S),A=w(S,k),x=t._minHeight,L=v(x),N=w(x,L),U=t.left,O=v(U),F=w(U,O),V=t.center&&t.center.x,R=v(V),P=w(V,R),D=t.right,z=v(D),W=w(D,z),M=t.top,B=v(M),H=w(M,B),G=t.center&&t.center.y,q=v(G),Y=w(G,q),j=t.bottom,X=v(j),K=w(j,X),$=o.sandboxWidth,Z=o.sandboxHeight,J=[[I,b,O,F,R,P,z,W],[k,A,B,H,q,Y,X,K]],Q=0;2>Q;Q++)s=J[Q],d=s[0],_=s[1],c=s[2],u=s[3],h=s[4],f=s[5],y=s[6],p=s[7],a=r=0,d===i.SIZE?a=r=0/0:d===i.FILL?(a=1,"%"===c?a-=u:"#"===c?r=-u:"%"===y?a-=p:"#"===y&&(r=-p)):"%"===d?a=_:"#"===d?r=_:"%"===c?"%"===h?a=2*(f-u):"#"===h?(a=-2*u,r=2*f):"%"===y?a=1-u-p:"#"===y&&(a=1-u,r=-p):"#"===c?"%"===h?(a=2*f,r=-2*u):"#"===h?r=2*(f-u):"%"===y?(a=1-p,r=-u):"#"===y&&(a=1,r=-p-u):"%"===h?"%"===y?a=2*(p-f):"#"===y&&(a=-2*f,r=2*p):"#"===h&&("%"===y?(a=2*p,r=-2*f):"#"===y&&(r=2*(p-f))),o[g=0===Q?"width":"height"].x1=a,o[g].x2=r;J={minWidth:[E,C,O,F,R,P,z,W],minHeight:[L,N,B,H,q,Y,X,K]};for(Q in J)s=J[Q],d=s[0],_=s[1],c=s[2],u=s[3],h=s[4],f=s[5],y=s[6],p=s[7],a=r=l=0,d===i.SIZE?a=r=0/0:d===i.FILL?(a=1,"%"===c?a-=u:"#"===c?r=-u:"%"===y?a-=p:"#"===y&&(r=-p)):"%"===d?a=_:"#"===d?r=_:a=r=l=void 0,o[Q].x1=a,o[Q].x2=r,o[Q].x3=l;for(J=[[O,F,R,P,z,W],[B,H,q,Y,X,K]],Q=0;2>Q;Q++){if(s=J[Q],c=s[0],u=s[1],h=s[2],f=s[3],y=s[4],p=s[5],a=r=l=0,"%"===c)a=u;else if("#"===c)l=u;else if("%"===h)a=f,r=-.5;else if("#"===h)r=-.5,l=f;else if("%"===y)a=1-p,r=-1;else if("#"===y)a=1,r=-1,l=-p;else switch("left"===Q?n._defaultHorizontalAlignment:n._defaultVerticalAlignment){case"center":a=.5,r=-.5;break;case"end":a=1,r=-1}o[g=0===Q?"left":"top"].x1=a,o[g].x2=r,o[g].x3=l}$.x1="%"===z?W:0,$.x2="#"===z?W:0,Z.x1="%"===X?K:0,Z.x2="#"===X?K:0},_defaultHorizontalAlignment:"center",_defaultVerticalAlignment:"center"})});