define(["Ti/_/Layouts/Base","Ti/_/declare","Ti/UI","Ti/_/lang"],function(e,t,i,o){var n=o.isDef,a="px",r=Math.round;return t("Ti._.Layouts.Composite",e,{_doLayout:function(e,t,o,n,l){var s,d,_,c,u,h,f,p,g,y,v,w,m,I,b,T,E,C,x={width:0,height:0},S=e._children,k=0,A=[],L=[],N=S.length,U=this._measureNode;for(k=0;N>k;k++)s=e._children[k],s._alive&&s.domNode?(s._markedForLayout&&((s._preLayout&&s._preLayout(t,o,n,l)||s._needsMeasuring)&&U(s,s,s._layoutCoefficients,this),d=s._layoutCoefficients,_=d.width,g=d.minWidth,c=d.height,y=d.minHeight,u=d.sandboxWidth,h=d.sandboxHeight,p=d.left,f=d.top,w=_.x1*t+_.x2,void 0!==g.x1&&(w=Math.max(w,g.x1*t+g.x2)),m=c.x1*o+c.x2,void 0!==y.x1&&(m=Math.max(m,y.x1*o+y.x2)),v=s._getContentSize?s._getContentSize(w,m):s._layout._doLayout(s,isNaN(w)?t:w-s._borderLeftWidth-s._borderRightWidth,isNaN(m)?o:m-s._borderTopWidth-s._borderBottomWidth,isNaN(w),isNaN(m)),isNaN(w)&&(w=v.width+s._borderLeftWidth+s._borderRightWidth,void 0!==g.x1&&(w=Math.max(w,g.x1*t+g.x2))),isNaN(m)&&(m=v.height+s._borderTopWidth+s._borderBottomWidth,void 0!==y.x1&&(m=Math.max(m,y.x1*o+y.x2))),n&&0!==p.x1?A.push(s):T=p.x1*t+p.x2*w+p.x3,l&&0!==f.x1?L.push(s):E=f.x1*o+f.x2*m+f.x3,s._measuredSandboxWidth=b=u.x1*o+u.x2+w+(isNaN(T)?0:T),s._measuredSandboxHeight=I=h.x1*o+h.x2+m+(isNaN(E)?0:E),s._measuredWidth=w,s._measuredHeight=m,s._measuredLeft=T,s._measuredTop=E),s._measuredSandboxWidth>x.width&&(x.width=s._measuredSandboxWidth),s._measuredSandboxHeight>x.height&&(x.height=s._measuredSandboxHeight)):this.handleInvalidState(s,e);for(N=A.length,k=0;N>k;k++)s=A[k],p=s._layoutCoefficients.left,u=s._layoutCoefficients.sandboxWidth,s._measuredLeft=T=p.x1*x.width+p.x2*w+p.x3,s._measuredSandboxWidth=b=u.x1*o+u.x2+s._measuredWidth+T,b=s._measuredSandboxWidth,b>x.width&&(x.width=b);for(N=L.length,k=0;N>k;k++)s=L[k],f=s._layoutCoefficients.top,h=s._layoutCoefficients.sandboxHeight,s._measuredTop=E=f.x1*x.height+f.x2*m+f.x3,s._measuredSandboxHeight=I=h.x1*o+h.x2+s._measuredHeight+E,I=s._measuredSandboxHeight,I>x.height&&(x.height=I);for(N=S.length,k=0;N>k;k++)s=S[k],s._markedForLayout&&(i._elementLayoutCount++,C=s.domNode.style,C.zIndex=s.zIndex,C.left=r(s._measuredLeft)+a,C.top=r(s._measuredTop)+a,C.width=r(s._measuredWidth-s._borderLeftWidth-s._borderRightWidth)+a,C.height=r(s._measuredHeight-s._borderTopWidth-s._borderBottomWidth)+a,s._markedForLayout=!1,s.fireEvent("postlayout"));return this._computedSize=x},_getWidth:function(e,t){return!n(t)&&2>n(e.left)+n(e.center&&e.center.x)+n(e.right)&&(t=e._defaultWidth),t===i.INHERIT?e._parent._parent?e._parent._parent._layout._getWidth(e._parent,e._parent.width)===i.SIZE?i.SIZE:i.FILL:i.FILL:t},_getHeight:function(e,t){return!n(t)&&2>n(e.top)+n(e.center&&e.center.y)+n(e.bottom)&&(t=e._defaultHeight),t===i.INHERIT?e._parent._parent?e._parent._parent._layout._getHeight(e._parent,e._parent.height)===i.SIZE?i.SIZE:i.FILL:i.FILL:t},_isDependentOnParent:function(e){var t=e._layoutCoefficients;return!isNaN(t.width.x1)&&0!==t.width.x1||!isNaN(t.height.x1)&&0!==t.height.x1||0!==t.left.x1||0!==t.top.x1},_doAnimationLayout:function(e,t){var i=e._parent._measuredWidth,o=e._parent._measuredHeight,n=t.width.x1*i+t.width.x2,a=t.height.x1*o+t.height.x2;return{width:n,height:a,left:t.left.x1*i+t.left.x2*n+t.left.x3,top:t.top.x1*o+t.top.x2*a+t.top.x3}},_measureNode:function(e,t,o,n){e._needsMeasuring=!1;for(var a,r,l,s,d,_,c,u,h,f,p,g,y,v=n.getValueType,w=n.computeValue,m=n._getWidth(e,t.width),I=v(m),b=w(m,I),T=t._minWidth,E=v(T),C=w(T,E),x=n._getHeight(e,t.height),S=v(x),k=w(x,S),A=t._minHeight,L=v(A),N=w(A,L),U=t.left,F=v(U),V=w(U,F),O=t.center&&t.center.x,R=v(O),P=w(O,R),D=t.right,z=v(D),M=w(D,z),W=t.top,B=v(W),H=w(W,B),G=t.center&&t.center.y,q=v(G),Y=w(G,q),j=t.bottom,X=v(j),$=w(j,X),Z=o.sandboxWidth,K=o.sandboxHeight,J=[[I,b,F,V,R,P,z,M],[S,k,B,H,q,Y,X,$]],Q=0;2>Q;Q++)s=J[Q],d=s[0],_=s[1],c=s[2],u=s[3],h=s[4],f=s[5],p=s[6],g=s[7],a=r=0,d===i.SIZE?a=r=0/0:d===i.FILL?(a=1,"%"===c?a-=u:"#"===c?r=-u:"%"===p?a-=g:"#"===p&&(r=-g)):"%"===d?a=_:"#"===d?r=_:"%"===c?"%"===h?a=2*(f-u):"#"===h?(a=-2*u,r=2*f):"%"===p?a=1-u-g:"#"===p&&(a=1-u,r=-g):"#"===c?"%"===h?(a=2*f,r=-2*u):"#"===h?r=2*(f-u):"%"===p?(a=1-g,r=-u):"#"===p&&(a=1,r=-g-u):"%"===h?"%"===p?a=2*(g-f):"#"===p&&(a=-2*f,r=2*g):"#"===h&&("%"===p?(a=2*g,r=-2*f):"#"===p&&(r=2*(g-f))),o[y=0===Q?"width":"height"].x1=a,o[y].x2=r;J={minWidth:[E,C,F,V,R,P,z,M],minHeight:[L,N,B,H,q,Y,X,$]};for(Q in J)s=J[Q],d=s[0],_=s[1],c=s[2],u=s[3],h=s[4],f=s[5],p=s[6],g=s[7],a=r=l=0,d===i.SIZE?a=r=0/0:d===i.FILL?(a=1,"%"===c?a-=u:"#"===c?r=-u:"%"===p?a-=g:"#"===p&&(r=-g)):"%"===d?a=_:"#"===d?r=_:a=r=l=void 0,o[Q].x1=a,o[Q].x2=r,o[Q].x3=l;for(J=[[F,V,R,P,z,M],[B,H,q,Y,X,$]],Q=0;2>Q;Q++){if(s=J[Q],c=s[0],u=s[1],h=s[2],f=s[3],p=s[4],g=s[5],a=r=l=0,"%"===c)a=u;else if("#"===c)l=u;else if("%"===h)a=f,r=-.5;else if("#"===h)r=-.5,l=f;else if("%"===p)a=1-g,r=-1;else if("#"===p)a=1,r=-1,l=-g;else switch("left"===Q?n._defaultHorizontalAlignment:n._defaultVerticalAlignment){case"center":a=.5,r=-.5;break;case"end":a=1,r=-1}o[y=0===Q?"left":"top"].x1=a,o[y].x2=r,o[y].x3=l}Z.x1="%"===z?M:0,Z.x2="#"===z?M:0,K.x1="%"===X?$:0,K.x2="#"===X?$:0},_defaultHorizontalAlignment:"center",_defaultVerticalAlignment:"center"})});