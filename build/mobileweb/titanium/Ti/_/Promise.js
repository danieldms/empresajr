define(["./declare","./lang"],function(e,t){var i=require.is,o=e("Ti._.Promise",null,{constructor:function(e){this._canceller=e},resolve:function(e){this._complete(e,0)},reject:function(e){this._complete(e,1)},then:function(e,t){var i={resolved:e,error:t,promise:new o(this.cancel)};return this._nextListener?this._head=this._head.next=i:this._nextListener=this._head=i,this._finished&&this._notify(this._fired),i.returnPromise},cancel:function(){if(!this._finished){var e=this._canceller&&this._canceller(this);this._finished||(e instanceof Error||(e=Error(e)),e.log=!1,this.reject(e))}},_fired:-1,_complete:function(e,t){if(this._fired=t,this._finished)throw Error("This promise has already been resolved");this._result=e,this._finished=!0,this._notify(t)},_notify:function(e){for(var o,a,n;this._nextListener;)if(a=this._nextListener,this._nextListener=this._nextListener.next,o=a[e?"error":"resolved"])try{n=o(this._result),n&&i(n.then,"Function")?n.then(t.hitch(a.promise,"resolve"),t.hitch(a.promise,"reject")):a.promise.resolve(n)}catch(r){a.promise.reject(r)}else a.promise[e?"reject":"resolve"](result)}});return o.when=function(e,t,o,a){return e&&i(e.then,"function")?e.then(t,o,a):t?t(e):e},o});