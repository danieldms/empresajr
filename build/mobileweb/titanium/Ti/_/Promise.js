define(["./declare","./lang"],function(e,t){var i=require.is,o=e("Ti._.Promise",null,{constructor:function(e){this._canceller=e},resolve:function(e){this._complete(e,0)},reject:function(e){this._complete(e,1)},then:function(e,t){var i={resolved:e,error:t,promise:new o(this.cancel)};return this._nextListener?this._head=this._head.next=i:this._nextListener=this._head=i,this._finished&&this._notify(this._fired),i.returnPromise},cancel:function(){if(!this._finished){var e=this._canceller&&this._canceller(this);this._finished||(e instanceof Error||(e=Error(e)),e.log=!1,this.reject(e))}},_fired:-1,_complete:function(e,t){if(this._fired=t,this._finished)throw Error("This promise has already been resolved");this._result=e,this._finished=!0,this._notify(t)},_notify:function(e){for(var o,n,r;this._nextListener;)if(n=this._nextListener,this._nextListener=this._nextListener.next,o=n[e?"error":"resolved"])try{r=o(this._result),r&&i(r.then,"Function")?r.then(t.hitch(n.promise,"resolve"),t.hitch(n.promise,"reject")):n.promise.resolve(r)}catch(a){n.promise.reject(a)}else n.promise[e?"reject":"resolve"](result)}});return o.when=function(e,t,o,n){return e&&i(e.then,"function")?e.then(t,o,n):t?t(e):e},o});