define(["Ti/_/declare","Ti/_/UI/Widget","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/_/text!Ti/_/UI/WebViewBridge.js","Ti/App","Ti/API","Ti/UI","Ti/_/style"],function(e,t,i,o,a,l,n,r,s,d){var _=require.on;return e("Ti.UI.WebView",t,{constructor:function(){n.addEventListener(this.widgetId+":unload",a.hitch(this,function(){this._loading(1)})),this.backgroundColor="#fff",d.set(this.domNode,{overflow:"auto",overflowScrolling:"touch"})},destroy:function(){n.removeEventListener(this.widgetId+":unload"),this._destroy(),t.prototype.destroy.apply(this,arguments)},_destroy:function(){this._iframe&&(o.off(this._iframeHandles),i.destroy(this._iframe))},_createIFrame:function(){if(this._parent){this._destroy(),this._loading(1);var e=this.url||"",t=e.match(/(https?)\:\/\/([^\:\/]*)(:?\d*)(.*)/),o=window.location,a=!t||t[0]+":"===o.protocol&&t[1]+t[2]===window.location.host,n=this._iframe=i.create("iframe",{frameborder:0,marginwidth:0,marginheight:0,hspace:0,vspace:0,scrolling:this.showScrollbars?"auto":"no",src:e||require.toUrl("Ti/_/UI/blank.html"),style:{width:"100%",height:"100%",position:"absolute"}},this.domNode);return this._iframeHandles=[_(n,"load",this,function(){var e,t,i,o=Math.max(0|a,0),s=n.contentWindow;if(-1!==o)a=-1;else for(e in s){o++;break}o>0?(t=s.location.href,this.evalJS(l.replace("WEBVIEW_ID",this.widgetId+":unload")),(i=this.properties.__values__.html)&&this._setContent(i)):r.warn("Unable to inject WebView bridge into cross-domain URL, ignore browser security message"),this._loading(),this.fireEvent("load",{url:t?this.properties.__values__.url=t:this.url})}),_(n,"error",this,function(){this._loading(),this.fireEvent("error",{message:"Page failed to load",url:this.url})})],1}},_setParent:function(){t.prototype._setParent.apply(this,arguments),(this.url||this.html)&&this._createIFrame()},_getWindow:function(){return this._iframe.contentWindow},_getDoc:function(){return this._getWindow().document},_getHistory:function(){return this._getWindow().history},_loading:function(e){this.loading||e&&this.fireEvent("beforeload",{url:this.url}),this.constants.loading=!!e},canGoBack:function(){return this.url&&!!this._getHistory().length},canGoForward:function(){return this.url&&!!this._getHistory().length},evalJS:function(e){var t=this._getWindow(),i=null;try{i=e&&t&&t.eval&&t.eval(e)}catch(o){}return i},goBack:function(){if(this.canGoBack()){var e=this._getHistory();e&&(this._loading(1),e.go(-1))}},goForward:function(){if(this.canGoForward()){var e=this._getHistory();e&&(this._loading(1),e.go(1))}},reload:function(){var e=this._getWindow();this.url&&e?e.location.href=this.url:this._createIFrame()},stopLoading:function(e){try{this.loading&&e?this._destroy():this._getWindow().stop()}catch(t){}this._loading()},_defaultWidth:s.FILL,_defaultHeight:s.FILL,_getContentSize:function(){return{width:this._iframe?this._iframe.clientWidth:0,height:this._iframe?this._iframe.clientHeight:0}},_setContent:function(e){try{var t=this._getDoc();t.open(),t.write(e),t.close()}catch(i){}return e},properties:{data:{set:function(e){var t=e;switch(t&&t.declaredClass){case"Ti.Filesystem.File":t=t.read();case"Ti.Blob":t=""+t;default:this.html=t}return e}},html:{get:function(e){var t=this._iframe&&this._getDoc();return void 0===e&&t?t.documentElement.innerHTML:e},post:function(e){var t=this.properties.__values__;t.data=void 0,t.url=void 0,this._createIFrame()&&this._setContent(e)}},showScrollbars:{set:function(e){return this._iframe&&i.attr.set(this._iframe,"scrolling",e?"auto":"no"),e},value:!0},url:{post:function(){var e=this.properties.__values__;e.data=void 0,e.html=void 0,this._createIFrame()}}},constants:{loading:!1}})});