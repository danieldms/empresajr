define(["Ti/_/declare","Ti/_/Evented","Ti/_/style","Ti/UI"],function(e,t,i,o){function l(){o._layoutInProgress?u.once(o,"postlayout",function(){requestAnimationFrame(a)}):requestAnimationFrame(a)}function a(){var e,t,i,o,a,r,n,_,u,y,f,h,p,w=c();s=0;for(e in E)for(t=E[e],a=0;t.length>a;a++)if(i=t[a],!i.paused){if(y=i.duration?Math.min(1,(w-i.ts)/i.duration):1,f=d[i.curve](i.forward?y:1-y),o=i.elem,o._isAttachedToActiveWin())for(prop in i.props){if(p=i.props[prop],_=p[0],u=p[1],1===y&&(h=i.forward?u:_),"transform"===prop){if(1!==y){for(h=[],n=_.length,r=0;n>r;r++)(12>r||r>14)&&(h[r]=_[r]+(u[r]-_[r])*f);s=1}16===h.length?(r=h.splice(12),h="matrix3d("+h.join(",")+") rotate3d("+r.join(",")+"deg)"):(r=h.pop(),h="matrix("+h.join(",")+") rotate("+r+"deg)"),prop=C}else if(g[prop]){if(1!==y){for(h=[],r=0;4>r;r++)h[r]=Math.floor(_[r]+(u[r]-_[r])*f);s=1}h="rgba("+h.join(",")+")"}else v[prop]&&(1!==y&&(h=_+(u-_)*f,s=1),h="opacity"===prop?h:h+"px");i.prev!==h&&(o.domNode.style[prop]=h),i.prev=h}1===y&&(i.ts=w,i.duration&&i.reverse&&i.forward?(i.forward=0,s=1):i.repeat-->0?s=i.forward=1:(t.splice(a--,1),i.promise.resolve(),t.length||delete E[e]))}s&&l()}function r(e){var t,i,o,l;if(e=e.trim().toLowerCase(),"#"===e.charAt(0))i=4==e.length?4:8,isNaN(e=Number("0x"+e.substring(1)))||(o=(1<<i)-1,l=4===i?17:1,l=[(e>>2*i&o)*l,(e>>i&o)*l,(e&o)*l,1]);else if(t=e.match(w))for(l=t[1].split(/\s*,\s*/),t=0;3>t;)l[t++]|=0;else k&&(l=k[e]);return l?(l[3]=isNaN(t=parseFloat(l[3]))?1:Math.min(Math.max(t,0),1),l):void 0}function n(e,t,i,o){var l,a,r,n,s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];if(e)if(l=e[1],a=e[2].split(","),r=a.length,l&&16===r)for(n=0;12>n;n++)s[n]=a[n];else l||6!==r||(s[0]=a[0],s[1]=a[1],s[4]=a[2],s[5]=a[3],s[3]=a[4],s[7]=a[5]);if(t)if(l=t[1],a=t[2].split(","),r=a.length,l&&4===r)for(n=0;4>n;n++)s[12+n]=a[n];else l||1!==r||(s[14]=1,s[15]=a[0]);return i=2===o?[i.a,i.b,0,i.tx,i.c,i.d,0,i.ty,0,0,1,0,0,0,1,i.rotation]:[i.m11,i.m12,i.m13,i.m14,i.m21,i.m22,i.m23,i.m24,i.m31,i.m32,i.m33,i.m34,i.rotationX,i.rotationY,i.rotationZ,i.rotation],[s,i]}for(var s,d=[function(e){return e*=2,1>e?Math.pow(e,2)/2:-1*(--e*(e-2)-1)/2},function(e){return Math.pow(e,2)},function(e){return-1*e*(e-2)},function(e){return e}],_=window,c=Date.now,u=require.on,y=0,f=["ms","moz","webkit","o"],h=f.length,p={autoreverse:1,bottom:1,center:1,curve:1,delay:1,duration:1,repeat:1,right:1,visible:1,zIndex:1},g={backgroundColor:1,color:1},v={height:1,left:1,opacity:1,top:1,width:1},w=/^rgba?\(([\s\.,0-9]+)\)/,I=/3d/,b=/^Ti\.UI\.(2|3)DMatrix$/,m=/matrix(3d)?\(([^\)]*)/,T=/rotate(3d)?\(([^\)]*)/,E={},C=i.discover("transform"),k=require(require.config.ti.colorsModule),S=e("Ti.UI.Animation",t,{properties:{autoreverse:void 0,backgroundColor:void 0,bottom:void 0,center:void 0,color:void 0,curve:void 0,delay:void 0,duration:void 0,height:void 0,left:void 0,opacity:void 0,repeat:void 0,right:void 0,top:void 0,transform:void 0,visible:void 0,width:void 0,zIndex:void 0}});--h>=0&&!_.requestAnimationFrame;)_.requestAnimationFrame=_[f[h]+"RequestAnimationFrame"];return _.requestAnimationFrame||(_.requestAnimationFrame=function(e){var t=c(),i=Math.max(0,16-(t-y)),o=window.setTimeout(function(){e(t+i)},i);return y=t+i,o}),S._play=function(e,t){function o(){var o,a,w,C,k,S,A,x,L,F,U={},O=e._parent._layout.calculateAnimation(e,t);for(w in h)if(S=h[w],!p[w]&&void 0!==S){for(o=0;f.length>o;o++)delete f[o].props[w],require.isEmpty(f[o].props)&&f.splice(o--,1);if(C=i.get(e.domNode,w),g[w])C=r(C),S=r(S),(S>C||C>S)&&(U[w]=[C,S]);else if(v[w])isNaN(C=parseFloat(C))&&"opacity"===w&&(C=1),S=w in O?O[w]:S,C!==S&&(U[w]=[C,S]);else if("transform"===w&&(k=S.declaredClass.match(b))){if(k=0|k[1],L=C.match(m),F=C.match(T),I.test(C)||3===k)A=n(L,F,S,k),C=A[0],S=A[1];else if(2===k){if(C=[1,0,0,1,0,0,0],L)for(x=L[2].split(","),a=Math.min(6,x.length),o=0;a>o;o++)C[o]=parseFloat(x[o]);F&&(x=F[2].split(","),x.length&&(C[6]=parseFloat(x[0]))),S=[S.a,S.b,S.c,S.d,S.tx,S.ty,S.rotation],A=[C,S]}(S>C||C>S)&&(U[w]=A)}}E[u].push({id:y,elem:e,promise:_,props:U,ts:c(),reverse:!!h.autoreverse,forward:1,curve:Math.max(0,Math.min(d.length-1,0|h.curve)),duration:0|h.duration,repeat:!!h.repeat}),t.fireEvent("start"),s||(s=1,l())}function a(){for(var e=E[u],t=0,i=e&&e.length;i>t;t++)if(e[t].id===y)return e[t]}var _=new require.Promise,u=e.widgetId,y=0|1e9*Math.random(),f=E[u]=E[u]||[],h=t.properties.__values__,w=0|h.delay,C=!!h.visible;return w?setTimeout(o,w):o(),_.source=e,_.animation=t,_.pause=function(){var e=a();return e=!!e&&(e.paused||(e.paused=c())),t.fireEvent("pause"),e},_.resume=function(){var e=a();return e&&(e.paused&&(e.ts+=c()-e.paused),s||(s=1,l())),e=!!e&&!(e.paused=0),t.fireEvent("resume"),e},_.cancel=function(e){for(var o,l,a,r=E[u],n=0,s=r&&r.length,d=!1;s>n;n++)if(r[n].id===y){if(o=r[n],e){a=o.elem.domNode;for(l in o.props)s=o.props[l][0],i.set(a,l,v[l]&&"opacity"!==l?s+"px":s)}r.splice(n,1),r.length||delete E[u],d=!0;break}return t.fireEvent("cancel"),d},_.then(function(){void 0!==h.visible&&(e.visible=C),void 0!==h.zIndex&&(e.zIndex=zIndex),t.fireEvent("complete")})},S});