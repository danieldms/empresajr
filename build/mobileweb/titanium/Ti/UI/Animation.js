define(["Ti/_/declare","Ti/_/Evented","Ti/_/style","Ti/UI"],function(e,t,i,o){function l(){o._layoutInProgress?y.once(o,"postlayout",function(){requestAnimationFrame(a)}):requestAnimationFrame(a)}function a(){var e,t,i,o,a,r,n,d,y,u,f,h,p,g=c();s=0;for(e in E)for(t=E[e],a=0;t.length>a;a++)if(i=t[a],!i.paused){if(u=i.duration?Math.min(1,(g-i.ts)/i.duration):1,f=_[i.curve](i.forward?u:1-u),o=i.elem,o._isAttachedToActiveWin())for(prop in i.props){if(p=i.props[prop],d=p[0],y=p[1],1===u&&(h=i.forward?y:d),"transform"===prop){if(1!==u){for(h=[],n=d.length,r=0;n>r;r++)(12>r||r>14)&&(h[r]=d[r]+(y[r]-d[r])*f);s=1}16===h.length?(r=h.splice(12),h="matrix3d("+h.join(",")+") rotate3d("+r.join(",")+"deg)"):(r=h.pop(),h="matrix("+h.join(",")+") rotate("+r+"deg)"),prop=C}else if(v[prop]){if(1!==u){for(h=[],r=0;4>r;r++)h[r]=Math.floor(d[r]+(y[r]-d[r])*f);s=1}h="rgba("+h.join(",")+")"}else I[prop]&&(1!==u&&(h=d+(y-d)*f,s=1),h="opacity"===prop?h:h+"px");i.prev!==h&&(o.domNode.style[prop]=h),i.prev=h}1===u&&(i.ts=g,i.duration&&i.reverse&&i.forward?(i.forward=0,s=1):i.repeat-->0?s=i.forward=1:(t.splice(a--,1),i.promise.resolve(),t.length||delete E[e]))}s&&l()}function r(e){var t,i,o,l;if(e=e.trim().toLowerCase(),"#"===e.charAt(0))i=4==e.length?4:8,isNaN(e=Number("0x"+e.substring(1)))||(o=(1<<i)-1,l=4===i?17:1,l=[(e>>2*i&o)*l,(e>>i&o)*l,(e&o)*l,1]);else if(t=e.match(g))for(l=t[1].split(/\s*,\s*/),t=0;3>t;)l[t++]|=0;else S&&(l=S[e]);return l?(l[3]=isNaN(t=parseFloat(l[3]))?1:Math.min(Math.max(t,0),1),l):void 0}function n(e,t,i,o){var l,a,r,n,s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];if(e)if(l=e[1],a=e[2].split(","),r=a.length,l&&16===r)for(n=0;12>n;n++)s[n]=a[n];else l||6!==r||(s[0]=a[0],s[1]=a[1],s[4]=a[2],s[5]=a[3],s[3]=a[4],s[7]=a[5]);if(t)if(l=t[1],a=t[2].split(","),r=a.length,l&&4===r)for(n=0;4>n;n++)s[12+n]=a[n];else l||1!==r||(s[14]=1,s[15]=a[0]);return i=2===o?[i.a,i.b,0,i.tx,i.c,i.d,0,i.ty,0,0,1,0,0,0,1,i.rotation]:[i.m11,i.m12,i.m13,i.m14,i.m21,i.m22,i.m23,i.m24,i.m31,i.m32,i.m33,i.m34,i.rotationX,i.rotationY,i.rotationZ,i.rotation],[s,i]}for(var s,_=[function(e){return e*=2,1>e?Math.pow(e,2)/2:-1*(--e*(e-2)-1)/2},function(e){return Math.pow(e,2)},function(e){return-1*e*(e-2)},function(e){return e}],d=window,c=Date.now,y=require.on,u=0,f=["ms","moz","webkit","o"],h=f.length,p={autoreverse:1,bottom:1,center:1,curve:1,delay:1,duration:1,repeat:1,right:1,visible:1,zIndex:1},v={backgroundColor:1,color:1},I={height:1,left:1,opacity:1,top:1,width:1},g=/^rgba?\(([\s\.,0-9]+)\)/,w=/3d/,b=/^Ti\.UI\.(2|3)DMatrix$/,m=/matrix(3d)?\(([^\)]*)/,T=/rotate(3d)?\(([^\)]*)/,E={},C=i.discover("transform"),S=require(require.config.ti.colorsModule),k=e("Ti.UI.Animation",t,{properties:{autoreverse:void 0,backgroundColor:void 0,bottom:void 0,center:void 0,color:void 0,curve:void 0,delay:void 0,duration:void 0,height:void 0,left:void 0,opacity:void 0,repeat:void 0,right:void 0,top:void 0,transform:void 0,visible:void 0,width:void 0,zIndex:void 0}});--h>=0&&!d.requestAnimationFrame;)d.requestAnimationFrame=d[f[h]+"RequestAnimationFrame"];return d.requestAnimationFrame||(d.requestAnimationFrame=function(e){var t=c(),i=Math.max(0,16-(t-u)),o=window.setTimeout(function(){e(t+i)},i);return u=t+i,o}),k._play=function(e,t){function o(){var o,a,g,C,S,k,A,x,L,U,F={},z=e._parent._layout.calculateAnimation(e,t);for(g in h)if(k=h[g],!p[g]&&void 0!==k){for(o=0;f.length>o;o++)delete f[o].props[g],require.isEmpty(f[o].props)&&f.splice(o--,1);if(C=i.get(e.domNode,g),v[g])C=r(C),k=r(k),(k>C||C>k)&&(F[g]=[C,k]);else if(I[g])isNaN(C=parseFloat(C))&&"opacity"===g&&(C=1),k=g in z?z[g]:k,C!==k&&(F[g]=[C,k]);else if("transform"===g&&(S=k.declaredClass.match(b))){if(S=0|S[1],L=C.match(m),U=C.match(T),w.test(C)||3===S)A=n(L,U,k,S),C=A[0],k=A[1];else if(2===S){if(C=[1,0,0,1,0,0,0],L)for(x=L[2].split(","),a=Math.min(6,x.length),o=0;a>o;o++)C[o]=parseFloat(x[o]);U&&(x=U[2].split(","),x.length&&(C[6]=parseFloat(x[0]))),k=[k.a,k.b,k.c,k.d,k.tx,k.ty,k.rotation],A=[C,k]}(k>C||C>k)&&(F[g]=A)}}E[y].push({id:u,elem:e,promise:d,props:F,ts:c(),reverse:!!h.autoreverse,forward:1,curve:Math.max(0,Math.min(_.length-1,0|h.curve)),duration:0|h.duration,repeat:!!h.repeat}),t.fireEvent("start"),s||(s=1,l())}function a(){for(var e=E[y],t=0,i=e&&e.length;i>t;t++)if(e[t].id===u)return e[t]}var d=new require.Promise,y=e.widgetId,u=0|1e9*Math.random(),f=E[y]=E[y]||[],h=t.properties.__values__,g=0|h.delay,C=!!h.visible;return g?setTimeout(o,g):o(),d.source=e,d.animation=t,d.pause=function(){var e=a();return e=!!e&&(e.paused||(e.paused=c())),t.fireEvent("pause"),e},d.resume=function(){var e=a();return e&&(e.paused&&(e.ts+=c()-e.paused),s||(s=1,l())),e=!!e&&!(e.paused=0),t.fireEvent("resume"),e},d.cancel=function(e){for(var o,l,a,r=E[y],n=0,s=r&&r.length,_=!1;s>n;n++)if(r[n].id===u){if(o=r[n],e){a=o.elem.domNode;for(l in o.props)s=o.props[l][0],i.set(a,l,I[l]&&"opacity"!==l?s+"px":s)}r.splice(n,1),r.length||delete E[y],_=!0;break}return t.fireEvent("cancel"),_},d.then(function(){void 0!==h.visible&&(e.visible=C),void 0!==h.zIndex&&(e.zIndex=zIndex),t.fireEvent("complete")})},k});