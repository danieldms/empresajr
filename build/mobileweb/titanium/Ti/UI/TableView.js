define(["Ti/_/declare","Ti/_/UI/KineticScrollView","Ti/_/style","Ti/_/lang","Ti/UI/MobileWeb/TableViewSeparatorStyle","Ti/UI"],function(e,t,i,o,a,n){var r=i.set,l=require.is,s=o.isDef,d=.001,_=/(click|singletap|longpress)/;return e("Ti.UI.TableView",t,{constructor:function(){var e;this._initKineticScrollView(e=n.createView({width:n.INHERIT,height:n.SIZE,left:0,top:0,layout:n._LAYOUT_CONSTRAINING_VERTICAL}),"vertical","vertical",1),e._add(this._header=n.createView({height:n.SIZE,width:n.INHERIT,layout:n._LAYOUT_CONSTRAINING_VERTICAL})),e._add(this._sections=n.createView({height:n.SIZE,width:n.INHERIT,layout:n._LAYOUT_CONSTRAINING_VERTICAL})),e._add(this._footer=n.createView({height:n.SIZE,width:n.INHERIT,layout:n._LAYOUT_CONSTRAINING_VERTICAL})),this.data=[],this.constants.__values__.sections=[]},_handleMouseWheel:function(){this._fireScrollEvent("scroll")},_handleDragStart:function(){this.fireEvent("dragstart")},_handleDrag:function(e){this._fireScrollEvent("scroll",e)},_handleDragEnd:function(e,t,i){var o=this;if(s(i)){var a=i*i/(1.724*d)*(0>i?-1:1),r=Math.abs(i)/d,l=Math.min(0,Math.max(o._minTranslationY,o._currentTranslationY+a));o.fireEvent("dragend",{decelerate:!0}),o._animateToPosition(o._currentTranslationX,l,r,n.ANIMATION_CURVE_EASE_OUT,function(){o._setTranslation(o._currentTranslationX,l),o._endScrollBars(),o._fireScrollEvent("scrollend",e)})}},_fireScrollEvent:function(e,t){for(var i,o=0,a=this._contentContainer,n=-this._currentTranslationY,r=this._sections,l=r._children,s=l.length,d=0;s>d;d+=2){var _=l[d],c=n-_._measuredTop,u=_._measuredHeight-c;if(c>0&&u>0)for(var h=_._rows._children,f=1;h.length>f;f+=2){var y=h[f],p=c-y._measuredTop,g=y._measuredHeight-p;p>0&&g>0&&(o++,!i&&(i=y))}}this.fireEvent(e,{contentOffset:{x:0,y:n},contentSize:{width:r._measuredWidth,height:r._measuredHeight},firstVisibleItem:i,size:{width:a._measuredWidth,height:a._measuredHeight},totalItemCount:this.data.length,visibleItemCount:o,x:t&&t.x,y:t&&t.y})},_defaultWidth:n.FILL,_defaultHeight:n.FILL,_getContentOffset:function(){return{x:-this._currentTranslationX,y:-this._currentTranslationY}},fireEvent:function(e,i){var o,a=0,n=0,r=this._sections._children,l=this._tableViewRowClicked,s=this._tableViewSectionClicked;if(_.test(e)){if(l&&s){for(;r.length>a;a+=2){if(o=r[a]._rows._children.indexOf(l),-1!==o){n+=Math.floor(o/2);break}n+=r[a].rowCount}i.row=i.rowData=l,i.index=n,i.section=s,i.searchMode=!1,t.prototype.fireEvent.apply(this,arguments),this._tableViewRowClicked=null,this._tableViewSectionClicked=null}}else t.prototype.fireEvent.apply(this,arguments)},_createSeparator:function(){var e=n.createView({height:1,width:n.INHERIT,backgroundColor:"white"});return r(e.domNode,"minWidth","100%"),e},_createDecorationLabel:function(e){return n.createLabel({text:e,backgroundColor:"darkGrey",color:"white",width:n.INHERIT,height:n.SIZE,left:0,font:{fontSize:22}})},_refreshSections:function(){for(var e=0;this._sections._children.length>e;e+=2)this._sections._children[e]._refreshRows();this._triggerLayout()},_calculateLocation:function(e){for(var t,i=0,o=0;this._sections._children.length>o;o+=2)if(t=this._sections._children[o],i+=t.rowCount,i>e)return{section:t,localIndex:t.rowCount-(i-e)};return e==i?{section:t,localIndex:t.rowCount}:void 0},_insertRow:function(e,t){var i=this._calculateLocation(t);i&&i.section.add(e,i.localIndex),this._publish(e),this._refreshSections()},_removeRow:function(e){var t=this._calculateLocation(e);t&&(this._unpublish(t.section._rows._children[2*t.localIndex+1]),t.section._removeAt(t.localIndex))},appendRow:function(e){this._currentSection||(this._sections._add(this._currentSection=n.createTableViewSection({_tableView:this})),this.sections.push(this._currentSection),this._sections._add(this._createSeparator()),this.data.push(this._currentSection)),this._currentSection.add(e),this._publish(e),this._refreshSections()},deleteRow:function(e){this._removeRow(e)},insertRowAfter:function(e,t){this._insertRow(t,e+1)},insertRowBefore:function(e,t){this._insertRow(t,e)},updateRow:function(e,t){this._removeRow(e),this._insertRow(t,e)},scrollToIndex:function(e){var t=this._calculateLocation(e);t&&this._setTranslation(0,-t.section._measuredTop-t.section._rows._children[2*t.localIndex+1]._measuredTop)},scrollToTop:function(e){this._setTranslation(0,-e)},_insertSection:function(e,t){!l(e,"Array")&&(e=[e]);for(var i=0,o=e.length;o>i;i++)s(e[i].declaredClass)&&"Ti.UI.TableViewSection"==e[i].declaredClass||(e[i]=n.createTableViewSection(e[i])),this._sections._insertAt(e[i],t+i),t===o?this.sections.push(e[i]):this.sections.splice(t,0,e[i]);this._refreshSections()},_removeSection:function(e){this._sections._remove(this.sections[e]),this.sections.splice(e,1)},appendSection:function(e){this._insertSection(e,this.sections.length)},deleteSection:function(e){e in this.sections&&(this._sections._remove(this.sections[e]),this.sections.splice(e,1))},insertSectionBefore:function(e,t){this._insertSection(t,e)},insertSectionAfter:function(e,t){this._insertSection(t,e+1)},updateSection:function(e,t){this._removeSection(e),this._insertSection(t,e)},constants:{sectionCount:{get:function(){return this.sections.length}},sections:void 0},properties:{data:{set:function(e){if(l(e,"Array")){var t,i=[];this._sections._removeAllChildren(),this.constants.__values__.sections=[],this._currentSection=void 0;for(t in e)(!s(e[t].declaredClass)||"Ti.UI.TableViewRow"!=e[t].declaredClass&&"Ti.UI.TableViewSection"!=e[t].declaredClass)&&(e[t]=n.createTableViewRow(e[t]));for(t=0;e.length>t;t++)"Ti.UI.TableViewRow"===e[t].declaredClass?(this._currentSection||(this.appendSection(this._currentSection=n.createTableViewSection({_tableView:this})),i.push(this._currentSection)),this._currentSection.add(e[t])):"Ti.UI.TableViewSection"===e[t].declaredClass&&(e[t]._tableView=this,this.appendSection(this._currentSection=e[t]),i.push(this._currentSection)),this._publish(e[t]);return this._refreshSections(),i}}},footerTitle:{set:function(e,t){return t!=e&&(this._footer._removeAllChildren(),this._footer._add(this._createDecorationLabel(e))),e}},footerView:{set:function(e,t){return t!=e&&(this._footer._removeAllChildren(),this._footer._add(e)),e}},headerTitle:{set:function(e,t){return t!=e&&(this._header._removeAllChildren(),this._header._add(this._createDecorationLabel(e)),this._header._add(this._createSeparator())),e}},headerView:{set:function(e,t){return t!=e&&(this._header._removeAllChildren(),this._header._add(e)),e}},maxRowHeight:{post:"_refreshSections"},minRowHeight:{post:"_refreshSections"},rowHeight:{post:"_refreshSections",value:"50px"},separatorColor:{post:"_refreshSections",value:"lightGrey"},separatorStyle:{post:"_refreshSections",value:a.SINGLE_LINE}}})});